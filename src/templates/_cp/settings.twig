{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% block content %}
    <input type="hidden" name="action" value="{{ baseActionPath }}/save">
    {{ redirectInput(baseCpPath) }}

    <div class="readable">
        <h2>Settings</h2>
    </div>

    {{ forms.lightSwitchField({
        label: "Encrypt data"|t('patron'),
        instructions: "Encrypt data stored in the database."|t('patron'),
        id: 'encryptStorageData',
        name: 'encryptStorageData',
        on: settings.encryptStorageData,
        errors: settings.getErrors('encryptStorageData'),
        warning: "Changing this may result in misconfigured Providers."|t('patron'),
    }) }}

    {{ forms.lightSwitchField({
        label: "Auto populate Token environment(s)"|t('patron'),
        instructions: "When a new Token is created, auto assign it to an environment"|t('patron'),
        id: 'autoPopulateTokenEnvironments',
        name: 'autoPopulateTokenEnvironments',
        on: settings.autoPopulateTokenEnvironments,
        errors: settings.getErrors('autoPopulateTokenEnvironments'),
        toggle: "#mirror-provider-elements"
    }) }}

    <div id="mirror-provider-elements"{% if not settings.autoPopulateTokenEnvironments %} class="hidden"{% endif %}>
        {{ forms.lightSwitchField({
            label: "Auto populate Token environment(s) from Provider"|t('patron'),
            instructions: "Mirror the environments from the associated Provider"|t('patron'),
            id: 'applyProviderEnvironmentsToToken',
            name: 'applyProviderEnvironmentsToToken',
            on: settings.applyProviderEnvironmentsToToken,
            errors: settings.getErrors('applyProviderEnvironmentsToToken'),
        }) }}
    </div>

    {% set cols = {
        'value' : {
            type: 'singleline',
            heading: 'Value',
            width: '50'
        }
    } %}

    {% set rows = [] %}
    {% for environment in settings.environments %}
        {% set rows = rows|merge([{value: environment}]) %}
    {% endfor %}
    {{ forms.editableTableField({
        label: "Environments"|t('patron'),
        instructions: "Enter each environment on a new row."|t('patron'),
        id: 'environments',
        name: 'environments',
        addRowLabel: "Add an environment"|t('patron'),
        cols: cols,
        rows: rows,
        errors: settings.getErrors('environments')
    }) }}

    {{ forms.textField({
        label: "Callback Url Path"|t('patron'),
        instructions: "A vanity callback url path. (Ex: oauth/callback): "|t('patron'),
        class: "code",
        id: 'callbackUrlPath',
        name: 'callbackUrlPath',
        value: settings.callbackUrlPath,
        errors: settings.getErrors('callbackUrlPath'),
    }) }}

    <hr/>

    <div class="readable">
        <h2>General Info</h2>
        <table class="data fullwidth fixed-layout">
            <tbody>
            <tr>
                <th class="light">Callback Url</th>
                <td>{{ settings.callbackUrl }}</td>
            </tr>
            </tbody>
        </table>
    </div>
{% endblock %}